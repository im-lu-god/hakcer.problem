<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>公开赛审核平台</title>
  <!-- 引入 Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* 全局背景和容器 - 采用更鲜艳的渐变色 */
    .main-container {
      background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }
    .main-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2rem;
      width: 100%;
      max-width: 60rem;
    }
    /* 功能卡片样式 - 增加发光效果 */
    .feature-card {
      background: #ffffff;
      border-radius: 1.5rem;
      padding: 2.5rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 0 0 40px rgba(168, 192, 255, 0.5);
      width: 100%;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .feature-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2), 0 0 50px rgba(168, 192, 255, 0.7);
    }
    .btn {
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    .btn:hover::after {
      animation: pulse 1s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    @keyframes pulse {
      0% { transform: scale(0.1, 0.1) translate(-50%, -50%); opacity: 0; }
      50% { transform: scale(5, 5) translate(-50%, -50%); opacity: 1; }
      100% { transform: scale(10, 10) translate(-50%, -50%); opacity: 0; }
    }
    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 50;
      animation: fadeIn 0.5s, fadeOut 0.5s 2.5s forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }
    /* 新增的审核状态颜色 */
    .status-pending { color: #f97316; }
    .status-approved { color: #10b981; }
    .status-rejected { color: #ef4444; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="main-container">
    <div class="main-content">
      <h1 class="text-4xl md:text-5xl font-bold text-white drop-shadow-lg text-center mb-6">公开赛审核平台</h1>
      
      <!-- 提交题目申请卡片 -->
      <div id="problem-application-card" class="feature-card">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">题目申请</h2>
        <form id="submit-form" class="space-y-6">
          <div>
            <label for="problem-title" class="block text-sm font-medium text-gray-700">题目名称</label>
            <input type="text" id="problem-title" name="problemTitle" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 ease-in-out p-2">
          </div>
          <div>
            <label for="difficulty" class="block text-sm font-medium text-gray-700">难度</label>
            <select id="difficulty" name="difficulty" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 ease-in-out p-2">
              <option value="简单">简单</option>
              <option value="中等">中等</option>
              <option value="困难">困难</option>
            </select>
          </div>
          <div>
            <label for="problem-file" class="block text-sm font-medium text-gray-700">题目文件 (.md)</label>
            <input type="file" id="problem-file" name="problemFile" accept=".md" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
          </div>
          <div>
            <label for="attachments" class="block text-sm font-medium text-gray-700">附件文件 (.zip)</label>
            <input type="file" id="attachments" name="attachments" accept=".zip" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
          </div>
          <div class="flex items-center">
            <input type="checkbox" id="public-consent" required class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
            <label for="public-consent" class="ml-2 block text-sm text-gray-900">我已阅读并同意 <a href="#" class="text-indigo-600 hover:text-indigo-800">平台条款</a></label>
          </div>
          <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 btn">
            提交申请
          </button>
        </form>
        <div id="application-status" class="mt-4 text-center text-sm"></div>
      </div>

      <!-- 公开赛申请卡片 -->
      <div id="competition-application-card" class="feature-card">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">公开赛申请</h2>
        <form id="competition-submit-form" class="space-y-6">
          <div>
            <label for="competition-oj-nickname" class="block text-sm font-medium text-gray-700">负责人OJ昵称</label>
            <input type="text" id="competition-oj-nickname" name="ojNickname" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 ease-in-out p-2">
          </div>
          <div>
            <label for="competition-email" class="block text-sm font-medium text-gray-700">负责人邮箱</label>
            <input type="email" id="competition-email" name="email" required pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" title="请输入有效的邮箱地址" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 ease-in-out p-2">
          </div>
          <div>
            <label for="competition-problem-ids" class="block text-sm font-medium text-gray-700">相关题目ID (多个ID用逗号分隔)</label>
            <textarea id="competition-problem-ids" name="problemIds" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 ease-in-out p-2"></textarea>
          </div>
          <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 btn">
            提交公开赛申请
          </button>
        </form>
        <div id="competition-application-status" class="mt-4 text-center text-sm"></div>
      </div>

      <!-- 管理员登录卡片 -->
      <div id="admin-login-card" class="feature-card hidden">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">管理员登录</h2>
        <form id="admin-login-form" class="space-y-6">
          <div>
            <label for="admin-password" class="block text-sm font-medium text-gray-700">密码</label>
            <input type="password" id="admin-password" name="password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 ease-in-out p-2">
          </div>
          <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 btn">
            登录
          </button>
        </form>
      </div>

      <!-- 管理员面板卡片 -->
      <div id="admin-panel-card" class="feature-card hidden">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">管理员面板</h2>
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-medium text-gray-700">题目审核列表</h3>
          <button id="admin-logout-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 btn">
            退出登录
          </button>
        </div>
        
        <div id="application-list" class="space-y-4">
          <!-- 题目审核列表将在此处动态生成 -->
        </div>

        <h3 class="text-lg font-medium text-gray-700 mt-8 mb-4">公开赛审核列表</h3>
        <div id="competition-application-list" class="space-y-4">
          <!-- 公开赛审核列表将在此处动态生成 -->
        </div>
      </div>
    </div>
  </div>

  <!-- 提示信息容器 -->
  <div id="toast-container" class="space-y-2"></div>

  <script>
    // 基础配置
    const API_BASE_URL = window.location.origin;

    // ----- UI 辅助函数 -----
    const showToast = (message, isError = false) => {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast px-6 py-3 rounded-lg shadow-xl text-white font-medium ${isError ? 'bg-red-500' : 'bg-green-500'}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.remove();
      }, 3000);
    };

    const hideAllCards = () => {
      document.getElementById('problem-application-card').classList.add('hidden');
      document.getElementById('competition-application-card').classList.add('hidden');
      document.getElementById('admin-login-card').classList.add('hidden');
      document.getElementById('admin-panel-card').classList.add('hidden');
    };

    const showAdminPanelCard = () => {
      hideAllCards();
      document.getElementById('admin-panel-card').classList.remove('hidden');
      fetchAndDisplayApplications();
      fetchAndDisplayCompetitionApplications();
    };

    const hideAdminPanelCard = () => {
      hideAllCards();
      document.getElementById('problem-application-card').classList.remove('hidden');
      document.getElementById('competition-application-card').classList.remove('hidden');
      document.getElementById('admin-login-card').classList.remove('hidden');
    };

    const checkAdminStatusOnLoad = () => {
      const token = localStorage.getItem('adminToken');
      if (token) {
        // 简单校验令牌是否有效
        fetch(`${API_BASE_URL}/api/applications`, {
            headers: { 'Authorization': `Bearer ${token}` }
        }).then(response => {
            if (response.ok) {
                showAdminPanelCard();
                showToast('已自动登录管理员面板。');
            } else {
                localStorage.removeItem('adminToken');
                hideAdminPanelCard();
                showToast('会话过期，请重新登录。');
            }
        }).catch(() => {
            localStorage.removeItem('adminToken');
            hideAdminPanelCard();
            showToast('会话过期，请重新登录。');
        });
      }
    };

    // ----- 题目申请功能 -----
    document.getElementById('submit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      
      const applicationData = {
        problemTitle: formData.get('problemTitle'),
        difficulty: formData.get('difficulty'),
        problemFile: null,
        attachments: null
      };

      const problemFile = formData.get('problemFile');
      if (problemFile) {
        applicationData.problemFile = await problemFile.text();
      }

      const attachments = formData.get('attachments');
      if (attachments && attachments.size > 0) {
        const reader = new FileReader();
        reader.onload = async (e) => {
            applicationData.attachments = e.target.result.split(',')[1];
            await sendProblemApplication(applicationData);
        };
        reader.readAsDataURL(attachments);
      } else {
        await sendProblemApplication(applicationData);
      }
    });

    const sendProblemApplication = async (data) => {
        try {
            const response = await fetch(`${API_BASE_URL}/api/apply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (response.ok) {
                document.getElementById('application-status').innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
                      <strong class="font-bold">申请成功!</strong>
                      <span class="block sm:inline">您的申请ID是: <span class="font-mono">${result.id}</span>。</span>
                    </div>
                `;
                showToast('题目申请提交成功！');
                document.getElementById('submit-form').reset();
            } else {
                showToast(`申请失败: ${result.error || '未知错误'}`, true);
            }
        } catch (error) {
            console.error('提交失败:', error);
            showToast('提交失败，请检查网络或稍后重试。', true);
        }
    };

    // ----- 公开赛申请功能 -----
    document.getElementById('competition-submit-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const ojNickname = formData.get('ojNickname');
        const email = formData.get('email');
        const problemIds = formData.get('problemIds').split(',').map(id => id.trim()).filter(id => id);

        try {
            const response = await fetch(`${API_BASE_URL}/api/competition/apply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ojNickname, email, problemIds })
            });

            const result = await response.json();
            if (response.ok) {
                document.getElementById('competition-application-status').innerHTML = `
                    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
                      <strong class="font-bold">申请成功!</strong>
                      <span class="block sm:inline">您的公开赛申请ID是: <span class="font-mono">${result.id}</span>。</span>
                    </div>
                `;
                showToast('公开赛申请提交成功！');
                document.getElementById('competition-submit-form').reset();
            } else {
                showToast(`申请失败: ${result.error || '未知错误'}`, true);
            }
        } catch (error) {
            console.error('公开赛申请提交失败:', error);
            showToast('公开赛申请提交失败，请检查网络或稍后重试。', true);
        }
    });
    
    // ----- 管理员登录功能 -----
    document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('admin-password').value;
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const result = await response.json();
            if (response.ok) {
                localStorage.setItem('adminToken', result.token);
                showToast('登录成功！');
                showAdminPanelCard();
            } else {
                showToast(result.error || '密码错误', true);
            }
        } catch (error) {
            console.error('登录失败:', error);
            showToast('登录失败，请检查网络或稍后重试。', true);
        }
    });

    document.getElementById('admin-logout-btn').addEventListener('click', () => {
      localStorage.removeItem('adminToken');
      hideAdminPanelCard();
      showToast('已退出登录。');
    });

    // ----- 管理员面板 - 获取和显示题目申请列表 -----
    const fetchAndDisplayApplications = async () => {
        const token = localStorage.getItem('adminToken');
        if (!token) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/applications`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.status === 401) {
                localStorage.removeItem('adminToken');
                hideAdminPanelCard();
                showToast('会话过期，请重新登录。', true);
                return;
            }
            const applications = await response.json();
            const listContainer = document.getElementById('application-list');
            listContainer.innerHTML = ''; // 清空列表
            if (applications.length === 0) {
              listContainer.innerHTML = '<p class="text-center text-gray-500">暂无题目申请。</p>';
              return;
            }

            applications.forEach(app => {
                const applicationItem = document.createElement('div');
                applicationItem.className = 'p-4 rounded-lg bg-gray-50 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-3';
                const statusClass = `status-${app.status || 'pending'}`;
                applicationItem.innerHTML = `
                    <div>
                        <p class="text-sm font-medium text-gray-900">${app.problemTitle} (<span class="font-mono text-xs">${app.id}</span>)</p>
                        <p class="text-xs text-gray-500 mt-1">难度: ${app.difficulty} | 提交于: ${new Date(app.submittedAt).toLocaleString()}</p>
                        <p class="text-sm font-bold mt-2 ${statusClass}">状态: ${app.status === 'approved' ? '已批准' : app.status === 'rejected' ? '已拒绝' : '待审核'}</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="downloadFile('${app.id}', 'description')" class="py-2 px-4 rounded-md text-sm font-medium text-indigo-600 border border-indigo-600 hover:bg-indigo-50 transition btn">下载描述</button>
                        ${app.attachments ? `<button onclick="downloadFile('${app.id}', 'attachments')" class="py-2 px-4 rounded-md text-sm font-medium text-indigo-600 border border-indigo-600 hover:bg-indigo-50 transition btn">下载附件</button>` : ''}
                        <button onclick="changeStatus('${app.id}', 'approve')" class="py-2 px-4 rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition btn ${app.status === 'approved' ? 'opacity-50 cursor-not-allowed' : ''}" ${app.status === 'approved' ? 'disabled' : ''}>批准</button>
                        <button onclick="changeStatus('${app.id}', 'reject')" class="py-2 px-4 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition btn ${app.status === 'rejected' ? 'opacity-50 cursor-not-allowed' : ''}" ${app.status === 'rejected' ? 'disabled' : ''}>拒绝</button>
                    </div>
                `;
                listContainer.appendChild(applicationItem);
            });
        } catch (error) {
            console.error('获取申请列表失败:', error);
            showToast('获取申请列表失败，请检查网络。', true);
        }
    };
    
    // ----- 管理员面板 - 获取和显示公开赛申请列表 -----
    const fetchAndDisplayCompetitionApplications = async () => {
        const token = localStorage.getItem('adminToken');
        if (!token) return;
        
        try {
            const response = await fetch(`${API_BASE_URL}/api/competition/applications`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.status === 401) {
                localStorage.removeItem('adminToken');
                hideAdminPanelCard();
                showToast('会话过期，请重新登录。', true);
                return;
            }
            const applications = await response.json();
            const listContainer = document.getElementById('competition-application-list');
            listContainer.innerHTML = ''; // 清空列表
            if (applications.length === 0) {
              listContainer.innerHTML = '<p class="text-center text-gray-500">暂无公开赛申请。</p>';
              return;
            }

            applications.forEach(app => {
                const applicationItem = document.createElement('div');
                applicationItem.className = 'p-4 rounded-lg bg-gray-50 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-3';
                const statusClass = `status-${app.status || 'pending'}`;
                applicationItem.innerHTML = `
                    <div>
                        <p class="text-sm font-medium text-gray-900">${app.ojNickname} 的公开赛申请 (<span class="font-mono text-xs">${app.id}</span>)</p>
                        <p class="text-xs text-gray-500 mt-1">邮箱: ${app.email} | 提交于: ${new Date(app.submittedAt).toLocaleString()}</p>
                        <p class="text-xs text-gray-500 mt-1">相关题目ID: ${app.problemIds.join(', ')}</p>
                        <p class="text-sm font-bold mt-2 ${statusClass}">状态: ${app.status === 'approved' ? '已批准' : app.status === 'rejected' ? '已拒绝' : '待审核'}</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="downloadCompetitionFiles('${app.id}')" class="py-2 px-4 rounded-md text-sm font-medium text-indigo-600 border border-indigo-600 hover:bg-indigo-50 transition btn">下载题目描述</button>
                        <button onclick="changeCompetitionStatus('${app.id}', 'approve')" class="py-2 px-4 rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition btn ${app.status === 'approved' ? 'opacity-50 cursor-not-allowed' : ''}" ${app.status === 'approved' ? 'disabled' : ''}>批准</button>
                        <button onclick="changeCompetitionStatus('${app.id}', 'reject')" class="py-2 px-4 rounded-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 transition btn ${app.status === 'rejected' ? 'opacity-50 cursor-not-allowed' : ''}" ${app.status === 'rejected' ? 'disabled' : ''}>拒绝</button>
                    </div>
                `;
                listContainer.appendChild(applicationItem);
            });
        } catch (error) {
            console.error('获取公开赛申请列表失败:', error);
            showToast('获取公开赛申请列表失败，请检查网络。', true);
        }
    };


    // ----- 管理员面板 - 修改题目申请状态 -----
    window.changeStatus = async (id, newStatus) => {
        const token = localStorage.getItem('adminToken');
        if (!token) return;

        try {
            const response = await fetch(`${API_BASE_URL}/api/status/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (response.ok) {
                showToast(`申请 ${id} 状态已更新为 ${newStatus === 'approve' ? '已批准' : '已拒绝'}。`);
                fetchAndDisplayApplications(); // 刷新列表
            } else if (response.status === 401) {
              localStorage.removeItem('adminToken');
              hideAdminPanelCard();
              showToast('会话过期，请重新登录。');
            } else {
                const errorText = await response.text();
                showToast(`更新状态失败: ${errorText}`, true);
            }
        } catch (error) {
            console.error('Update status failed:', error);
            showToast('更新状态失败，请检查网络或稍后重试。', true);
        }
    };

    // ----- 管理员面板 - 修改公开赛申请状态 -----
    window.changeCompetitionStatus = async (id, newStatus) => {
        const token = localStorage.getItem('adminToken');
        if (!token) return;

        try {
            const response = await fetch(`${API_BASE_URL}/api/competition/status/${id}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (response.ok) {
                showToast(`公开赛申请 ${id} 状态已更新为 ${newStatus === 'approve' ? '已批准' : '已拒绝'}。`);
                fetchAndDisplayCompetitionApplications(); // 刷新列表
            } else if (response.status === 401) {
              localStorage.removeItem('adminToken');
              hideAdminPanelCard();
              showToast('会话过期，请重新登录。', true);
            } else {
                const errorText = await response.text();
                showToast(`更新状态失败: ${errorText}`, true);
            }
        } catch (error) {
            console.error('Update competition status failed:', error);
            showToast('更新状态失败，请检查网络或稍后重试。', true);
        }
    };

    // ----- 管理员面板 - 下载文件 -----
    window.downloadFile = async (id, fileType) => {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          showToast('请先登录。', true);
          return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/api/download/${id}/${fileType}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
              if (response.status === 401) {
                localStorage.removeItem('adminToken');
                hideAdminPanelCard();
                showToast('会话过期，请重新登录。');
                return;
              }
              const errorText = await response.text();
              showToast(`下载失败: ${errorText}`, true);
              return;
            }
            
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = downloadUrl;
            
            let filename = '';
            const contentDisposition = response.headers.get('Content-Disposition');
            if (contentDisposition) {
              const filenameMatch = contentDisposition.match(/filename=\"(.+)\"/);
              if (filenameMatch) {
                filename = filenameMatch[1];
              }
            }
            
            a.download = filename || `${id}-${fileType}.${fileType === 'description' ? 'md' : 'zip'}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(downloadUrl);
            document.body.removeChild(a);
            showToast('下载成功！');

        } catch (error) {
            console.error('Download failed:', error);
            showToast('下载失败，请检查网络或稍后重试。', true);
        }
    };

    // ----- 管理员面板 - 下载公开赛题目文件 -----
    window.downloadCompetitionFiles = async (id) => {
        const token = localStorage.getItem('adminToken');
        if (!token) {
          showToast('请先登录。', true);
          return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/api/competition/download/${id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
              if (response.status === 401) {
                localStorage.removeItem('adminToken');
                hideAdminPanelCard();
                showToast('会话过期，请重新登录。');
                return;
              }
              const errorText = await response.text();
              showToast(`下载失败: ${errorText}`, true);
              return;
            }
            
            const blob = await response.blob();
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = downloadUrl;
            
            a.download = `competition-problems-${id}.zip`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(downloadUrl);
            document.body.removeChild(a);
            showToast('下载成功！');

        } catch (error) {
            console.error('Download competition files failed:', error);
            showToast('下载失败，请检查网络或稍后重试。', true);
        }
    };

    // 页面加载时执行
    window.onload = checkAdminStatusOnLoad;

    // ----- 开发者工具检测和禁用 -----
    let isDevToolsOpen = false;
    let shouldRefreshOnDevTools = true; // 默认启用刷新功能

    const checkDevTools = () => {
      const isDevToolsOpen = window.outerWidth - window.innerWidth > 100 ||
                             window.outerHeight - window.innerHeight > 100;
      if (isDevToolsOpen) {
        // 如果开发者工具已打开，并且标志为true，则反复刷新页面
        if (shouldRefreshOnDevTools) {
          showToast('警告: 检测到开发者工具已打开！页面将反复刷新。');
          // 设置一个定时器来反复刷新页面
          setInterval(() => {
            location.reload();
          }, 500);
        } else {
          showToast('警告: 检测到开发者工具已打开！');
        }
        // 调用 debugger 以立即暂停执行
        (function() { debugger; })();
      }
    };
    setInterval(checkDevTools, 500);

    // 禁用 F12, Ctrl+Shift+I 和右键菜单，并增加 Ctrl+Shift+L
    document.addEventListener('keydown', (e) => {
      // 禁用 F12
      if (e.key === 'F12' || e.keyCode === 123) {
        e.preventDefault();
        showToast('F12 已被禁用。');
      }
      // 禁用 Ctrl+Shift+I
      if (e.ctrlKey && e.shiftKey && e.key === 'I') {
        e.preventDefault();
        showToast('Ctrl+Shift+I 已被禁用。');
      }
      // Ctrl+Shift+L 进入管理员登录
      if (e.ctrlKey && e.shiftKey && e.key === 'L') {
        e.preventDefault();
        hideAllCards();
        document.getElementById('admin-login-card').classList.remove('hidden');
      }
    });
    
    // 禁用右键菜单
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      showToast('右键菜单已被禁用。');
    });

  </script>
</body>
</html>



